Fully functional (local and cloud) backend for execution in AWS Lambda and AWS
API Gateway, and deployed using GitHub Actions using the `serverless` tool.

This service is a micro-service so avoid globbing it with mutliple controllers,
unless absolutely necessary. Addtional services can be configured within the
`scaffoldly-bootstrap` project.

Generated using [Scaffoldly](https://scaffold.ly/). More information can be
found in the [Scaffoldly Documentation](https://docs.scaffold.ly/)

### Features

- Serverless: Managed deployments to Lambda and API Gateway using GitHub actions

- Express: Familar backend API for Node, but wired up to work on API Gateway

- OpenAPI: Uses tsoa to take decorated controllers to auto-generate and serve
  API specification. The entire project is in TypeScript for strong typing from
  the API down to the DynamoDB tables.

- AuthN/AuthZ: Integrated with `sly-auth-api` in this organization for
  centralized authentication/authorization

- Service Discovery: `scaffoldly-bootstrap` managed configuration files in
  `./scaffoldly` for simple service discovery

- Local Debugability: The preconfigured environment generates the needed source
  maps for the ability to set and introspect breakpoints

# Getting Started

1. Go to project folder and install dependencies:

```bash
yarn
```

2. Open the project in [VSCode](https://code.visualstudio.com/), and press `F5` to run.

# Debugging

You can place breakpoints in any of the files, and VSCode will pause execution
for introspection when running locally.

## Steps Taken

When running (or deploying) a project, the following steps are automatically taken:

- `yarn dotenv`: Generates `src/env.ts` from the environment configuration in
  `./scaffoldly`
- `yarn types`: Generates interfaces based on schema files in
  `./src/models/schemas` using `joi-to-typescript`
- `yarn openapi`: Generates `src/routes.ts` and `src/swagger.json` for Express
  Routing and the OpenAPI specification, respectively.
- `yarn dynamodb`: Prepares `dynamodb-local` for local interaction with DynamoDB
- `yarn tsc`: Compiles typescript files for debugging.

# Adding Controllers

To add a new controller, create a file named `*Controller*.ts` to the
`./src/controllers` directory, and it will be automatically discovered and
and hosted on Serverless + Express.

Controllers are decorated using a library called `tsoa` for automatic library
generation.

Copy/pasting an existing controller is currently the recommended way to make a
new controller.

# Adding Models

This service is configured to have a DynamoDB table as a persistent store.

The table itself is defined in `serverless.yml`, and it's code-model is defined
in `./src/models`, and the schemas are defined in `./src/models/schemas`.

Copy/pasting an existing model and schema is currently the recommended way to
make a new controller.

Schema interfaces are auto-generated using the `joi-to-typescript` tool, and
created when `yarn types` is executed.

# Adding Services

Services are an (optional) abstraction layer between the Controllers and the
Models, resuliting in visually clean controllers.

Copy/pasting an existing service is currently the recommended way to make a new
service.

# OpenAPI Auto-Generation

Using [Decorators](https://tsoa-community.github.io/docs/getting-started.html#defining-a-simple-controller)
from tsoa on controllers in `./src/controllers`, an OpenAPI v3 specification is
automatically generated:

- On Save (in VSCode)
- `yarn openapi` command

The OpenAPI file is hosted at http://localhost:3000/{service-name}/openapi.json

Frontend services use this predictable URL to auto-generate client libraries.

# Releases

## Non-Live Releases

Check-ins to `main` automatically trigger a non-live deploy which can be
observed in _Actions > Nonlive Deploy_.

Non-live releases are automatically versioned and draft releases are created.

## Live Releases

Each non-live release creates a draft release in GitHub (located in the
_Releases_ section to the right.

To trigger a release, edit the Draft Release and choose _Publish_.

The release can be observed in _Actions > Nonlive Deploy_.

# Project structure

```
.build/                      output from the tsc command
.dynamodb/                   dynamodb local storage
.github/                     github workflow files for releases and deployments
.scaffoldly/                 AUTOGENERATED scaffoldly configuration for service discovery, managed by the scaffoldly-bootstrap project
|- live/                     AUTOGENERATED configurations specific to running in live environment, deployments overwrite files in /.scaffoldly
|- nonlive/                  AUTOGENERATED configurations specific to running in live environment, deployments overwrite files in /.scaffoldly
|- env-vars.json             AUTOGENERATED JSON representation of environment, managed by the scaffoldly-bootstrap project
|- services.json             AUTOGENERATED JSON representation of all backend services in this organization, managed by the scaffoldly-bootstrap project
|- shared-env-vars.json      AUTOGENERATED JSON representation of any organization-wide environment variables, managed by the scaffoldly-bootstrap project
.webpack/                    output from serverless offline
src/                         project source code
|- controllers/              controllers for the REST API, decorated with tsoa annotations
|- interfaces/               generic interfaces used throughout the project
|- models/                   dynamodb data models
|  |- interfaces/            AUTOGENERATED by `yarn types` command from schemas defined in ./schemas
|  |- schemas/               joi schemas, used to autogenerate interfaces and for the dynamodb library
|- services/                 core logic, singleton services
|- app.ts                    main application that wires up express to run in Serverless + Lambda
|- auth.ts                   required from tsoa for pluggable authentication modules
|- constants.ts              any constants needed project wide
|- env.ts                    AUTOGENERATED by `yarn dotenv` command, based on config in ../.scaffoldly/
|- lambda.ts                 entrypoint for Lambda functions into app.ts
|- routes.ts                 AUTOGENERATED by `yarn tsoa` command, based on decorators on controllers in ./controllers/
|- swagger.json              AUTOGENERATED by `yarn tsoa` command, based on decorators on controllers in ./controllers/
.env                         environment variables needed to run locally
.env.live                    envoirnment variables needed to run in live environment (merged with .env at runtime)
.env.nonlive                 envoirnment variables needed to run in nonlive environment (merged with .env at runtime)
.serverless.config.js        invoked by `serverless` commands to programatically inject the service and application name
serverless.yml               configuration for serverless and API gateway, and other cloud resources
tsoa.js                      script for `yarn tsoa` command, generates `routes.ts` and `swagger.json`
types.ts                     script for `yarn types` command, generates interfaces from schemas defined in ./src/models/schemas
```
